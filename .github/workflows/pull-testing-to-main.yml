name: Weekly Pull Request (Testing -> Main)

on:
  schedule:
    - cron: '0 8 * * TUE' # Every Tuesday at 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if a PR already exists
          PR_EXISTS=$(gh pr list --base main --head testing --json url --jq '.[0].url')
          
          if [ -z "$PR_EXISTS" ]; then
            echo "Creating new Pull Request..."
            gh pr create \
              --base main \
              --head testing \
              --title "Weekly Merge: Testing to Main" \
              --body "This is an automated weekly pull request to merge changes from testing into main. This PR is created every Tuesday before the stable build."
          else
            echo "Pull Request already exists: $PR_EXISTS"
          fi
